<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cengiz Bilgi Sistemi — Ultra Performans Tek Parsel (ZIP + Shapefile + TopoJSON)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
:root{--primary:#1e3c72;--accent:#2a5298}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;height:100vh;display:flex;flex-direction:column}
header{background:var(--primary);color:#fff;padding:12px 18px;display:flex;align-items:center;justify-content:space-between}
header .title{font-weight:700}
#controls{display:flex;gap:8px;padding:10px;border-bottom:3px solid var(--primary);flex-wrap:wrap;background:#fff}
#controls input{padding:8px;border:1px solid #ddd;border-radius:6px;min-width:120px}
#controls button{padding:8px 12px;border-radius:6px;border:none;background:var(--primary);color:#fff;cursor:pointer}
#main{display:flex;flex:1;min-height:0}
#map{flex:3;min-height:0}
#sidebar{flex:1;min-width:260px;max-width:520px;border-left:3px solid var(--accent);background:#fafafa;overflow:auto;padding:10px}
#parcelItems{list-style:none;padding:0;margin:0}
#parcelItems li{background:#fff;padding:8px;margin-bottom:6px;border-radius:6px;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.05)}
#parcelItems li:hover{transform:translateY(-1px)}
.meta{font-size:0.9em;color:#444}
.small{font-size:0.85em;color:#666}
.controls-right{display:flex;gap:8px}
.status{font-size:0.85em;color:#222;margin-left:14px}
.highlighted-item{outline:3px solid rgba(255,200,0,0.6); background:#fff8e1}
@media (max-width:900px){#sidebar{display:none}}
</style>
</head>
<body>

<header>
  <div class="title">Cengiz Bilgi Sistemi — Turbo Parsel</div>
  <div style="display:flex;align-items:center">
    <div class="status" id="status">Hazır</div>
  </div>
</header>

<div id="controls">
  <input id="il_ad" placeholder="İl (örn: ankara)" />
  <input id="ilce_ad" placeholder="İlçe (örn: çankaya)" />
  <input id="mahalle_ad" placeholder="Mahalle" />
  <input id="adano" placeholder="Ada No" />
  <input id="parselno" placeholder="Parsel No" />
  <div class="controls-right">
    <button id="filterBtn">Sorgula</button>
    <button id="clearBtn">Temizle</button>
    <button id="downloadKml">KML İndir</button>
    <input type="file" id="zipFile" accept=".zip" />
    <button id="loadZipBtn">ZIP Yükle</button>
  </div>
</div>

<div id="main">
  <div id="map"></div>
  <div id="sidebar">
    <h3>Sorgu Sonuçları <small class="small" id="resultCount"></small></h3>
    <ul id="parcelItems"></ul>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.vectorgrid/dist/Leaflet.VectorGrid.bundled.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tokml@0.3.0/tokml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://unpkg.com/shapefile@0.7.4/shapefile.js"></script>
<script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>

<script>
const map = L.map('map',{preferCanvas:true}).setView([39,35],6);
L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']}).addTo(map);

let vectorGridLayer=null, highlightLayer=null, hoverLayer=null;
const featureIndex=new Map();
const indexBy={il:new Map(), ilce:new Map(), mahalle:new Map(), ada:new Map(), parsel:new Map()};
const filteredKeys=new Set();
let worker=null;

function makeKey(p){ return [(p.il_ad||'').toLowerCase(),(p.ilce_ad||'').toLowerCase(),(p.mahalle_ad||'').toLowerCase(),(p.adano||''),(p.parselno||'')].join('::'); }
function ensureSet(m,k){ if(!m.has(k)) m.set(k,new Set()); return m.get(k); }
function intersectSets(sets){ if(sets.length===0) return new Set(); sets.sort((a,b)=>a.size-b.size); const r=new Set(sets[0]); for(let i=1;i<sets.length;i++){ for(const v of r) if(!sets[i].has(v)) r.delete(v); } return r; }
function setStatus(txt){ document.getElementById('status').textContent=txt; }
function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

// Worker
function createWorker(){
  if(worker){ worker.terminate(); worker=null; }
  const code=`self.onmessage=function(e){const m=e.data;if(m.cmd==='parse'){try{const fc=JSON.parse(m.payload);const features=fc.features||[];const CHUNK=5000;for(let i=0;i<features.length;i+=CHUNK){const chunk=features.slice(i,i+CHUNK);for(const f of chunk) if(!f.properties) f.properties={};postMessage({type:'chunk',features:chunk,progress:Math.min(1,(i+CHUNK)/features.length)});}postMessage({type:'done',count:features.length);}catch(err){postMessage({type:'error',message:err.message||String(err));}}}};`;
  worker=new Worker(URL.createObjectURL(new Blob([code],{type:'application/javascript'})));
  worker.onmessage=handleWorkerMessage;
}
function handleWorkerMessage(ev){
  const d=ev.data;
  if(d.type==='chunk'){ setStatus('İndeksleniyor '+Math.round(d.progress*100)+'%'); indexFeaturesBatch(d.features); }
  else if(d.type==='done'){ setStatus('Yüklendi '+d.count+' özellik'); finalizeAfterLoad(); }
  else if(d.type==='error'){ setStatus('Worker hata: '+d.message); alert('Worker hata: '+d.message); }
}

// Indexing
function indexFeaturesBatch(features){
  for(const f of features){
    if(!f.properties) f.properties={};
    const key=makeKey(f.properties);
    if(featureIndex.has(key)) continue;
    featureIndex.set(key,f);
    const p=f.properties;
    ensureSet(indexBy.il,(p.il_ad||'').toLowerCase()).add(key);
    ensureSet(indexBy.ilce,(p.ilce_ad||'').toLowerCase()).add(key);
    ensureSet(indexBy.mahalle,(p.mahalle_ad||'').toLowerCase()).add(key);
    ensureSet(indexBy.ada,p.adano||'').add(key);
    ensureSet(indexBy.parsel,p.parselno||'').add(key);
  }
}

// VectorGrid
function createOrUpdateVectorGrid(geoJson){
  if(vectorGridLayer) map.removeLayer(vectorGridLayer);
  vectorGridLayer=L.vectorGrid.slicer(geoJson,{
    rendererFactory:L.canvas.tile,interactive:true,tolerance:8,extent:2048,buffer:128,maxZoom:20,
    vectorTileLayerStyles:{'*':{fill:true,fillColor:'#3388ff',fillOpacity:0.22,color:'#3568d6',weight:1}},
    getFeatureId:f=>makeKey(f.properties||{})
  }).addTo(map);

  vectorGridLayer.on('click',e=>{
    const f=featureIndex.get(makeKey(e.layer.properties||{})); if(!f) return;
    highlightFeature(f); filteredKeys.add(makeKey(f.properties)); requestListUpdate();
    setTimeout(()=>{
      const li=document.querySelector(`#parcelItems li[data-key="${CSS.escape(makeKey(f.properties))}"]`);
      if(li){ li.scrollIntoView({behavior:'smooth',block:'center'}); li.classList.add('highlighted-item'); setTimeout(()=>li.classList.remove('highlighted-item'),1600);}
    },120);
  });
  vectorGridLayer.on('mouseover',e=>{
    const f=featureIndex.get(makeKey(e.layer.properties||{})); if(!f) return;
    if(!hoverLayer) hoverLayer=L.geoJSON(null,{style:{color:'#ffa500',weight:2,fillOpacity:0.08}}).addTo(map);
    hoverLayer.clearLayers(); hoverLayer.addData(f);
  });
  vectorGridLayer.on('mouseout',()=>{ if(hoverLayer) hoverLayer.clearLayers(); });
}

// Highlight
function ensureHighlightLayer(){ if(!highlightLayer) highlightLayer=L.geoJSON(null,{style:{color:'red',weight:2,fillOpacity:0.25}}).addTo(map); }
function highlightFeature(f){
  ensureHighlightLayer(); highlightLayer.clearLayers(); highlightLayer.addData(f);
  if(highlightLayer.getBounds&&!highlightLayer.getBounds().isEmpty()) map.fitBounds(highlightLayer.getBounds(),{maxZoom:18,padding:[18,18]});
  const p=f.properties||{};
  highlightLayer.bindPopup(`<b>İl:</b>${p.il_ad||'—'}<br><b>İlçe:</b>${p.ilce_ad||'—'}<br><b>Mahalle:</b>${p.mahalle_ad||'—'}<br><b>Ada:</b>${p.adano||'—'}<br><b>Parsel:</b>${p.parselno||'—'}`).openPopup();
}

// List
let pendingListUpdate=false;
function requestListUpdate(){ if(pendingListUpdate) return; pendingListUpdate=true; requestAnimationFrame(()=>{ pendingListUpdate=false; renderList(); }); }
function renderList(){
  const ul=document.getElementById('parcelItems'); ul.innerHTML='';
  const keys=Array.from(filteredKeys); document.getElementById('resultCount').textContent=keys.length?'('+keys.length+')':'(0)';
  const maxShow=800; const showKeys=keys.slice(0,maxShow);
  const frag=document.createDocumentFragment();
  for(const k of showKeys){ const f=featureIndex.get(k); if(!f) continue; const p=f.properties||{};
    const li=document.createElement('li'); li.dataset.key=k;
    li.innerHTML=`<strong>${escapeHtml(p.adano||'')}/${escapeHtml(p.parselno||'')}</strong><div class="meta">${escapeHtml(p.mahalle_ad||'')} — ${escapeHtml(p.ilce_ad||'')}/${escapeHtml(p.il_ad||'')}</div>`;
    li.onclick=()=>{highlightFeature(f); filteredKeys.add(k); requestListUpdate();};
    frag.appendChild(li);
  }
  ul.appendChild(frag);
  if(keys.length>maxShow){ const more=document.createElement('div'); more.className='small'; more.style.padding='8px'; more.textContent=`Toplam ${keys.length}. İlk ${maxShow} gösteriliyor.`; ul.appendChild(more); }
}

// Query
function queryParcelsFast(){
  const il=(document.getElementById('il_ad').value||'').trim().toLowerCase();
  const ilce=(document.getElementById('ilce_ad').value||'').trim().toLowerCase();
  const mahalle=(document.getElementById('mahalle_ad').value||'').trim().toLowerCase();
  const ada=(document.getElementById('adano').value||'').trim();
  const parsel=(document.getElementById('parselno').value||'').trim();
  const sets=[]; if(il){ const s=indexBy.il.get(il); if(!s) return setNoResults(); sets.push(s); }
  if(ilce){ const s=indexBy.ilce.get(ilce); if(!s) return setNoResults(); sets.push(s); }
  if(mahalle){ const s=indexBy.mahalle.get(mahalle); if(!s) return setNoResults(); sets.push(s); }
  if(ada){ const s=indexBy.ada.get(ada); if(!s) return setNoResults(); sets.push(s); }
  if(parsel){ const s=indexBy.parsel.get(parsel); if(!s) return setNoResults(); sets.push(s); }

  let r = sets.length===0? new Set(featureIndex.keys()) : intersectSets(sets);
  filteredKeys.clear(); for(const k of r) filteredKeys.add(k);
  requestListUpdate(); zoomToFeatures(Array.from(filteredKeys).slice(0,100).map(k=>featureIndex.get(k)));
  setStatus('Sonuç: '+filteredKeys.size);
}
function setNoResults(){ filteredKeys.clear(); requestListUpdate(); setStatus('Sonuç bulunamadı'); }

// Zoom
function zoomToFeatures(features){
  const pts=[]; for(const f of features){ if(!f||!f.geometry) continue; const g=f.geometry;
    if(g.type==='Polygon'){for(const ring of g.coordinates) for(const pt of ring) pts.push([pt[1],pt[0]]);}
    else if(g.type==='MultiPolygon'){for(const poly of g.coordinates) for(const ring of poly) for(const pt of ring) pts.push([pt[1],pt[0]]);}
    else if(g.type==='Point'){ pts.push([g.coordinates[1],g.coordinates[0]]); }
  }
  if(pts.length) map.fitBounds(pts,{padding:[18,18],maxZoom:18});
}

// KML
function downloadKml(){
  if(filteredKeys.size===0) return alert('Parsel seçilmedi!');
  const feats=[]; for(const k of filteredKeys){ const f=featureIndex.get(k); if(f) feats.push(f); }
  const fc={type:'FeatureCollection',features:feats};
  const kml=tokml(fc);
  const blob=new Blob([kml],{type:'application/vnd.google-earth.kml+xml'});
  const link=document.createElement('a'); link.href=URL.createObjectURL(blob); link.download='parseller.kml'; link.click();
}

// ZIP Load
document.getElementById('loadZipBtn').addEventListener('click', async ()=>{
  const f=document.getElementById('zipFile').files[0]; if(!f) return alert('ZIP seçin'); setStatus('ZIP okunuyor...');
  try{
    const zip=await JSZip.loadAsync(f,{streamFiles:true}); const geoFiles=[];
    zip.forEach((path,e)=>{ if(e.name.match(/\.(geojson|topojson|shp)$/i)) geoFiles.push(e); });
    if(geoFiles.length===0) return alert('ZIP içinde desteklenen dosya yok!');
    let selFile=geoFiles[0];
    if(geoFiles.length>1){ const names=geoFiles.map((e,i)=>`${i+1}: ${e.name}`).join('\n'); const choice=prompt('Dosya seçin:\n'+names,'1'); const idx=parseInt(choice)-1; if(idx>=0&&idx<geoFiles.length) selFile=geoFiles[idx]; }
    setStatus('Dosya çıkarılıyor: '+selFile.name);
    if(selFile.name.match(/\.(geojson|topojson)$/i)){
      const text=await selFile.async('text'); createWorker(); setStatus('Worker başlatılıyor...');
      worker.postMessage({cmd:'parse',payload:text});
    } else if(selFile.name.match(/\.shp$/i)){
      const arrayBuffer=await selFile.async('arraybuffer'); const source=await shapefile.open(arrayBuffer);
      const features=[]; let result;
      while(!(result=await source.read()).done){ features.push({type:'Feature',geometry:result.value.geometry,properties:result.value.properties||{}}); }
      createWorker(); setStatus('Worker başlatılıyor...'); worker.postMessage({cmd:'parse',payload:JSON.stringify({type:'FeatureCollection',features})});
    }
  } catch(err){ console.error(err); alert('ZIP yükleme hatası: '+err.message); setStatus('Hata oluştu'); }
});

// Events
document.getElementById('filterBtn').onclick=queryParcelsFast;
document.getElementById('clearBtn').onclick=()=>{ filteredKeys.clear(); requestListUpdate(); if(highlightLayer) highlightLayer.clearLayers(); setStatus('Temizlendi'); };
document.getElementById('downloadKml').onclick=downloadKml;

</script>
</body>
</html>
