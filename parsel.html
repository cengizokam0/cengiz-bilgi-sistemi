<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cengiz Bilgi Sistemi – Parsel Sorgulama</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
body { margin:0; font-family:Arial; }

header {
    background:#1e3c72;
    color:#fff;
    padding:15px 30px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

header a { color:white; text-decoration:none; margin-left:20px; font-weight:bold; }

#controls {
    padding:10px;
    background:#fff;
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    gap:5px;
    border-bottom:2px solid #1e3c72;
}

input, button {
    padding:6px 10px;
    font-size:1em;
}

button {
    background:#1e3c72;
    border:none;
    color:white;
    cursor:pointer;
    border-radius:4px;
}

#main { display:flex; height:86vh; }
#map { flex:3; }
#sidebar {
    flex:1;
    background:#fff;
    border-left:3px solid #2a5298;
    overflow-y:auto;
    padding:10px;
}

#parcelItems li {
    background:#eee;
    padding:6px;
    margin-bottom:4px;
    border-radius:4px;
    cursor:pointer;
}
#parcelItems li:hover { background:#ddd; }
</style>
</head>
<body>

<header>
    <div style="font-size:1.4em; font-weight:bold;">Cengiz Bilgi Sistemi</div>
    <nav>
        <a href="index.html">Ana Sayfa</a>
    </nav>
</header>

<div id="controls">
    <input type="text" id="il_ad" placeholder="İl" />
    <input type="text" id="ilce_ad" placeholder="İlçe" />
    <input type="text" id="mahalle_ad" placeholder="Mahalle" />
    <input type="text" id="adano" placeholder="Ada No" />
    <input type="text" id="parselno" placeholder="Parsel No" />
    <button id="filterBtn">Sorgula</button>
    <button id="clearBtn">Temizle</button>
    <button id="downloadKml">KML İndir</button>
</div>

<div id="main">
    <div id="map"></div>
    <div id="sidebar">
        <h3>Sorgulanan Parseller</h3>
        <ul id="parcelItems"></ul>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.vectorgrid/dist/Leaflet.VectorGrid.bundled.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tokml@0.3.0/tokml.js"></script>

<script>
var map = L.map('map').setView([39, 35], 6);

L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains:['mt0','mt1','mt2','mt3']
}).addTo(map);

var featureIndex = new Map();
var filteredFeatures = new Map();
var highlightLayer = null;
var vectorGridLayer = null;

function makeKey(p){
    return `${p.il_ad}-${p.ilce_ad}-${p.mahalle_ad}-${p.adano}-${p.parselno}`;
}

function loadGeoJSON(url){
    fetch(url)
      .then(res => res.json())
      .then(data => {
          featureIndex.clear();
          filteredFeatures.clear();
          document.getElementById("parcelItems").innerHTML = "";

          if(vectorGridLayer) map.removeLayer(vectorGridLayer);

          data.features.forEach(f=>{
              featureIndex.set(makeKey(f.properties), f);
          });

          vectorGridLayer = L.vectorGrid.slicer(data, {
              rendererFactory: L.canvas.tile,
              interactive: true,
              vectorTileLayerStyles: {
                  sliced: {
                      fill: true,
                      fillColor: '#3388ff',
                      fillOpacity: 0.2,
                      color: '#3388ff',
                      weight: 1
                  }
              },
              getFeatureId: f => makeKey(f.properties)
          }).addTo(map);

          vectorGridLayer.on("click", function(e){
              var props = e.layer.properties;
              var key = makeKey(props);
              var feature = featureIndex.get(key);
              if(!feature) return;

              highlightFeature(feature);

              if(!filteredFeatures.has(key)){
                  filteredFeatures.set(key, feature);
                  updateList();
              }
          });

          console.log("GeoJSON otomatik yüklendi.");
      })
      .catch(err => console.error("GeoJSON yüklenirken hata oluştu:", err));
}

window.onload = function(){
    loadGeoJSON('https://raw.githubusercontent.com/cengizokam0/cengiz-bilgi-sistemi/main/kadastro_parselleri.geojson');
};

function highlightFeature(feature){
    if(highlightLayer) map.removeLayer(highlightLayer);

    highlightLayer = L.geoJSON(feature, {
        style: { color:"red", weight:2, fillOpacity:0.4 }
    }).addTo(map);

    let p = feature.properties;

    highlightLayer.bindPopup(`
        <b>İl:</b> ${p.il_ad}<br>
        <b>İlçe:</b> ${p.ilce_ad}<br>
        <b>Mahalle:</b> ${p.mahalle_ad}<br>
        <b>Ada:</b> ${p.adano}<br>
        <b>Parsel:</b> ${p.parselno}
    `).openPopup();

    map.fitBounds(highlightLayer.getBounds());
}

function updateList(){
    let html = "";
    filteredFeatures.forEach((feature, key)=>{
        let p = feature.properties;
        html += `<li data-key="${key}">${p.adano}/${p.parselno} – ${p.mahalle_ad}</li>`;
    });

    document.getElementById("parcelItems").innerHTML = html;

    document.querySelectorAll("#parcelItems li").forEach(li=>{
        li.addEventListener("click", ()=> highlightFeature(featureIndex.get(li.dataset.key)));
    });
}

function queryParcels(){
    var il = il_ad.value.trim().toLowerCase();
    var ilce = ilce_ad.value.trim().toLowerCase();
    var mahalle = mahalle_ad.value.trim().toLowerCase();
    var ada = adano.value.trim();
    var parsel = parselno.value.trim();

    let matches = [];

    featureIndex.forEach((feature,key)=>{
        let p = feature.properties;

        if((!il || p.il_ad.toLowerCase()==il) &&
           (!ilce || p.ilce_ad.toLowerCase()==ilce) &&
           (!mahalle || p.mahalle_ad.toLowerCase()==mahalle) &&
           (!ada || p.adano==ada) &&
           (!parsel || p.parselno==parsel)){
            matches.push(feature);
            filteredFeatures.set(key, feature);
        }
    });

    if(matches.length===0) return alert("Sonuç bulunamadı!");

    updateList();
    zoomToFeatures(matches);
}

function zoomToFeatures(features){
    let pts = [];
    features.forEach(f=>{
        let g = f.geometry;
        if(g.type==="Polygon"){
            g.coordinates[0].forEach(pt=>pts.push([pt[1],pt[0]]));
        } else if(g.type==="MultiPolygon"){
            g.coordinates.forEach(poly=>{
                poly[0].forEach(pt=>pts.push([pt[1],pt[0]]));
            });
        }
    });
    if(pts.length>0) map.fitBounds(pts);
}

filterBtn.onclick = queryParcels;

clearBtn.onclick = ()=>{
    filteredFeatures.clear();
    document.getElementById("parcelItems").innerHTML = "";
    if(highlightLayer) map.removeLayer(highlightLayer);
};

downloadKml.onclick = ()=>{
    if(filteredFeatures.size===0) return alert("Parsel seçilmedi!");
    var kml = tokml({type:"FeatureCollection", features: Array.from(filteredFeatures.values())});
    var blob = new Blob([kml], {type:"application/vnd.google-earth.kml+xml"});
    var link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download="parseller.kml";
    link.click();
};
</script>
</body>
</html>
